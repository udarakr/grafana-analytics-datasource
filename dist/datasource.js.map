{"version":3,"sources":["../src/datasource.js"],"names":["_","TableModel","AnalyticsDatasource","instanceSettings","$q","backendSrv","type","url","name","q","options","opts","angular","copy","query","buildQueryParameters","targets","length","when","all","map","buildSeries","target","then","results","datasourceRequest","method","response","status","message","title","getTables","filter","metric","resp","data","v","a","b","c","console","error","table","keys","Object","values","columns","i","push","self","default","rows","getTableData","buildCoulmns","row","branch","forEach","r","k"],"mappings":";;;;;;;;;;;;;;;AAAOA,a;;AACKC,sB;;;;;;;;;;;;;;;;;;;;;;;;;;;2CAECC,mB;AAET,6CAAYC,gBAAZ,EAA8BC,EAA9B,EAAkCC,UAAlC,EAA8C;AAAA;;AAC1C,yBAAKC,IAAL,GAAYH,iBAAiBG,IAA7B;AACA,yBAAKC,GAAL,GAAWJ,iBAAiBI,GAA5B;AACA,yBAAKC,IAAL,GAAYL,iBAAiBK,IAA7B;;AAEA,yBAAKC,CAAL,GAASL,EAAT;AACA,yBAAKC,UAAL,GAAkBA,UAAlB;AACH;;;;0CAEKK,O,EAAS;AAAA;;AACX,4BAAIC,OAAOC,QAAQC,IAAR,CAAaH,OAAb,CAAX;AACA,4BAAII,QAAQ,KAAKC,oBAAL,CAA0BJ,IAA1B,CAAZ;;AAEA,4BAAIG,MAAME,OAAN,CAAcC,MAAd,IAAwB,CAA5B,EAA+B;AAC3B,mCAAO,KAAKR,CAAL,CAAOS,IAAP,CAAY,EAAZ,CAAP;AACH;;AAED,+BAAO,KAAKT,CAAL,CAAOU,GAAP,CAAWnB,EAAEoB,GAAF,CAAMN,MAAME,OAAZ,EAAqB,kBAAU;AAC7C,mCAAO,MAAKK,WAAL,CAAiBC,MAAjB,CAAP;AACH,yBAFiB,CAAX,EAEHC,IAFG,CAEE,mBAAW;AAChB,mCAAO,EAAC,QAAQC,OAAT,EAAP;AACH,yBAJM,CAAP,CAIG;AAEN;;;qDAEgB;AACb,+BAAO,KAAKnB,UAAL,CAAgBoB,iBAAhB,CAAkC;AACrClB,iCAAK,KAAKA,GAAL,GAAW,SADqB;AAErCmB,oCAAQ;AAF6B,yBAAlC,EAGJH,IAHI,CAGC,oBAAY;AAChB,gCAAII,SAASC,MAAT,KAAoB,GAAxB,EAA6B;AACzB,uCAAO,EAAEA,QAAQ,SAAV,EAAqBC,SAAS,kCAA9B,EAAkEC,OAAO,SAAzE,EAAP;AACH;AACJ,yBAPM,CAAP;AAQH;;;oDAEepB,O,EAAS;AACrB,4BAAGA,QAAQI,KAAR,KAAkB,OAArB,EAA6B;AACzB,mCAAO,KAAKiB,SAAL,CAAerB,QAAQY,MAAvB,CAAP;AACH,yBAFD,MAEM,IAAGZ,QAAQI,KAAR,KAAkB,QAArB,EAA8B;AAC5B,mCAAO,KAAKL,CAAL,CAAOS,IAAP,CAAY,CACf,EAAC,QAAQ,SAAT,EADe,CAAZ,CAAP;AAGP;;AAED,+BAAO,KAAKT,CAAL,CAAOS,IAAP,CAAY,EAAZ,CAAP;AACH;;;yDAEoBR,O,EAAS;AAC1BA,gCAAQM,OAAR,GAAkBhB,EAAEgC,MAAF,CAAStB,QAAQM,OAAjB,EAA0B,kBAAU;AAClD,mCAAOM,OAAOW,MAAd;AACH,yBAFiB,CAAlB;;AAIA,+BAAOvB,OAAP;AACH;;;8CAESY,M,EAAQ;AACd,+BAAO,KAAKjB,UAAL,CAAgBoB,iBAAhB,CAAkC;AACrClB,iCAAK,KAAKA,GAAL,GAAW,SADqB;AAErCmB,oCAAQ;AAF6B,yBAAlC,EAGJH,IAHI,CAGC,UAASW,IAAT,EAAc;AAClB,mCAAOlC,EAAEoB,GAAF,CAAMc,KAAKC,IAAX,EAAiB,UAASC,CAAT,EAAW;AAC/B,uCAAO,EAAC,QAAQA,CAAT,EAAP;AACH,6BAFM,CAAP;AAGH,yBAPM,EAOJ,UAASF,IAAT,EAAeG,CAAf,EAAiBC,CAAjB,EAAmBC,CAAnB,EAAqB;AACpBC,oCAAQC,KAAR,CAAcP,IAAd,EAAoBG,CAApB,EAAsBC,CAAtB,EAAwBC,CAAxB;AACH,yBATM,CAAP;AAUH;;;iDAEYjB,M,EAAQ;AACjB,+BAAO,KAAKjB,UAAL,CAAgBoB,iBAAhB,CAAkC;AACrClB,iCAAK,KAAKA,GAAL,GAAW,UAAX,GAAwBe,OAAOoB,KADC;AAErChB,oCAAQ;AAF6B,yBAAlC,CAAP;AAIH;;;8CAESJ,M,EAAQ;AACd,+BAAO,KAAKjB,UAAL,CAAgBoB,iBAAhB,CAAkC;AACrClB,iCAAK,KAAKA,GAAL,GAAW,UAAX,GAAwBe,OAAOoB,KAA/B,GAAuC,SADP;AAErChB,oCAAQ;AAF6B,yBAAlC,EAGJH,IAHI,CAGC,UAASW,IAAT,EAAc;AAClB,mCAAOA,KAAKC,IAAZ;AACH,yBALM,EAKJ,UAASD,IAAT,EAAeG,CAAf,EAAiBC,CAAjB,EAAmBC,CAAnB,EAAqB;AACpBC,oCAAQC,KAAR,CAAcP,IAAd,EAAoBG,CAApB,EAAsBC,CAAtB,EAAwBC,CAAxB;AACH,yBAPM,CAAP;AAQH;;;iDAEYL,I,EAAMQ,K,EAAM;AACrB,4BAAIC,OAAOC,OAAOD,IAAP,CAAYT,KAAKC,IAAL,CAAU,CAAV,EAAaU,MAAzB,CAAX;AACAH,8BAAMI,OAAN,GAAgB,EAAhB;AACA,6BAAI,IAAIC,IAAI,CAAR,EAAW9B,SAAS0B,KAAK1B,MAA7B,EAAqC8B,KAAK9B,MAA1C,EAAkD8B,GAAlD,EAAuD;AACnD,gCAAGJ,KAAKI,CAAL,CAAH,EAAW;AACPL,sCAAMI,OAAN,CAAcE,IAAd,CAAmB,EAAC,QAASL,KAAKI,CAAL,CAAV,EAAnB;AACH;AACJ;AACD,+BAAOJ,IAAP;AACH;;;gDAEWrB,M,EAAQ;AAAA;;AAChB,4BAAI2B,OAAO,IAAX;AACA,4BAAIN,IAAJ;AACA,4BAAGrB,OAAOW,MAAP,KAAkB,SAArB,EAA+B;AAAA,gCACvBS,KADuB;;AAAA;AACvBA,wCAAQ,IAAIzC,WAAWiD,OAAf,EADe;;AAE3B,oCAAIC,OAAO,EAAX;;AAEA;AAAA,uCAAO,OAAKC,YAAL,CAAkB9B,MAAlB,EAA0BC,IAA1B,CAA+B,gBAAQ;AAC1CoB,+CAAM,OAAKU,YAAL,CAAkBnB,IAAlB,EAAwBQ,KAAxB,CAAN;AACA,+CAAOO,KAAKxC,CAAL,CAAOU,GAAP,CAAWnB,EAAEoB,GAAF,CAAMc,KAAKC,IAAX,EAAiB,kBAAU;AACzC,gDAAImB,MAAMC,OAAOV,MAAjB;AACAM,iDAAKH,IAAL,CAAUM,GAAV;AACH,yCAHiB,CAAX,CAAP;AAIH,qCANM,EAMJ/B,IANI,CAMC,YAAU;AAAC;AACfvB,0CAAEwD,OAAF,CAAUL,IAAV,EAAgB,eAAO;AACnB,gDAAIR,OAAOC,OAAOD,IAAP,CAAYW,GAAZ,CAAX;AACA,gDAAIG,IAAI,EAAR;AACA,iDAAK,IAAIV,IAAI,CAAb,EAAgBA,IAAIJ,KAAK1B,MAAzB,EAAiC8B,GAAjC,EAAsC;AAClC,oDAAIW,IAAIf,KAAKI,CAAL,CAAR;AACAU,kDAAET,IAAF,CAAOM,IAAII,CAAJ,CAAP;AACH;AACFhB,kDAAMS,IAAN,CAAWH,IAAX,CAAgBS,CAAhB;AACF,yCARD;AASA,+CAAOf,KAAP;AACH,qCAjBM;AAAP;AAJ2B;;AAAA;AAsB9B;AACD,+BAAO,EAAP;AACH","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport * as TableModel from 'app/core/table_model';\n\nexport class AnalyticsDatasource {\n\n    constructor(instanceSettings, $q, backendSrv) {\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.name = instanceSettings.name;\n\n        this.q = $q;\n        this.backendSrv = backendSrv;\n    }\n\n    query(options) {\n        let opts = angular.copy(options);\n        let query = this.buildQueryParameters(opts);\n\n        if (query.targets.length <= 0) {\n            return this.q.when([]);\n        }\n\n        return this.q.all(_.map(query.targets, target => {\n            return this.buildSeries(target);\n        })).then(results => {\n            return {'data': results} \n        });;\n\n    }\n\n    testDatasource() {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + \"/tables\",\n            method: 'GET'\n        }).then(response => {\n            if (response.status === 200) {\n                return { status: \"success\", message: \"Analytics Data source is working\", title: \"Success\" };\n            }\n        });\n    }\n\n    metricFindQuery(options) {\n        if(options.query === 'table'){\n            return this.getTables(options.target);\n        }else if(options.query === 'metric'){\n                return this.q.when([\n                    {'text': 'select*'}\n                ]);\n        }\n\n        return this.q.when([]);\n    }\n\n    buildQueryParameters(options) {\n        options.targets = _.filter(options.targets, target => {\n            return target.metric;\n        });\n\n        return options;\n    }\n\n    getTables(target) {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/tables',\n            method: 'GET'\n        }).then(function(resp){\n            return _.map(resp.data, function(v){\n                return {'text': v}\n            });\n        }, function(resp, a,b,c){\n            console.error(resp, a,b,c)\n        });\n    }\n\n    getTableData(target) {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/tables/' + target.table,\n            method: 'GET'\n        });\n    }\n\n    getSchema(target) {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/tables/' + target.table + \"/schema\",\n            method: 'GET'\n        }).then(function(resp){\n            return resp.data;\n        }, function(resp, a,b,c){\n            console.error(resp, a,b,c)\n        });\n    }\n\n    buildCoulmns(resp, table){\n        var keys = Object.keys(resp.data[1].values);\n        table.columns = [];\n        for(var i = 0, length = keys.length; i <= length; i++) {\n            if(keys[i]){\n                table.columns.push({'text' : keys[i]});\n            }\n        }\n        return keys;\n    }\n\n    buildSeries(target) {\n        let self = this;\n        var keys;\n        if(target.metric === 'select*'){\n            var table = new TableModel.default();\n            let rows = [];\n\n            return this.getTableData(target).then(resp => {\n                keys= this.buildCoulmns(resp, table);\n                return self.q.all(_.map(resp.data, branch => {\n                    let row = branch.values;\n                    rows.push(row);\n                }));\n            }).then(function(){;\n                _.forEach(rows, row => {\n                    var keys = Object.keys(row);\n                    var r = [];\n                    for (var i = 0; i < keys.length; i++) {\n                        var k = keys[i];\n                        r.push(row[k]);\n                    }\n                   table.rows.push(r);\n                });\n                return table;\n            });\n        }\n        return [];\n    }\n}\n\n\n"]}